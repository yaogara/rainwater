---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { withBase } from "../../utils/paths";
import SearchBar from "../../components/SearchBar.astro";

function slugify(text) {
  return text.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
}

function getStateEmoji(name) {
  const map = {
    Alabama: "ðŸˆ",
    Alaska: "â„ï¸",
    Arizona: "ðŸŒµ",
    Arkansas: "ðŸŒ³",
    California: "ðŸŒ´",
    Colorado: "ðŸ”ï¸",
    Connecticut: "âš“",
    Delaware: "ðŸ–ï¸",
    Florida: "ðŸŠ",
    Georgia: "ðŸ‘",
    Hawaii: "ðŸŒº",
    Idaho: "ðŸ¥”",
    Illinois: "ðŸŒ†",
    Indiana: "ðŸŽï¸",
    Iowa: "ðŸŒ½",
    Kansas: "ðŸŒ»",
    Kentucky: "ðŸŽ",
    Louisiana: "ðŸŽ·",
    Maine: "ðŸ¦ž",
    Maryland: "ðŸ¦€",
    Massachusetts: "ðŸŽ“",
    Michigan: "ðŸŒŠ",
    Minnesota: "ðŸ§Š",
    Mississippi: "ðŸŸ",
    Missouri: "ðŸŒ‰",
    Montana: "ðŸ¦¬",
    Nebraska: "ðŸŒ¾",
    Nevada: "ðŸŽ°",
    "New Hampshire": "ðŸžï¸",
    "New Jersey": "ðŸ›£ï¸",
    "New Mexico": "ðŸŒ¶ï¸",
    "New York": "ðŸ—½",
    "North Carolina": "ðŸ–ï¸",
    "North Dakota": "ðŸŒ¾",
    Ohio: "ðŸˆ",
    Oklahoma: "ðŸŒªï¸",
    Oregon: "ðŸŒ²",
    Pennsylvania: "ðŸ””",
    "Rhode Island": "âš“",
    "South Carolina": "ðŸŒ´",
    "South Dakota": "ðŸ—¿",
    Tennessee: "ðŸŽ¸",
    Texas: "ðŸ¤ ",
    Utah: "ðŸœï¸",
    Vermont: "ðŸ",
    Virginia: "ðŸ›ï¸",
    "Washington": "ðŸŒ²",
    "West Virginia": "â›ï¸",
    Wisconsin: "ðŸ§€",
    Wyoming: "ðŸ¦¬",
    "District of Columbia": "ðŸ›ï¸",
  };
  return map[name] ?? "ðŸ—ºï¸";
}

const installers = await getCollection("installers");

const statesMap = new Map();

for (const installer of installers) {
  const stateName = installer.data.state;
  if (!stateName) continue;
  if (!statesMap.has(stateName)) {
    statesMap.set(stateName, {
      title: stateName,
      summary: installer.data.summary || `Rainwater harvesting installers and incentives in ${stateName}`,
    });
  } else {
    // If summary is missing, try to update it from installer data
    const current = statesMap.get(stateName);
    if (!current.summary && installer.data.summary) {
      current.summary = installer.data.summary;
    }
  }
}

const states = Array.from(statesMap.entries())
  .map(([title, data]) => ({ title, summary: data.summary }))
  .sort((a, b) => a.title.localeCompare(b.title));

const canonicalSite = (Astro.site?.toString() ?? "https://rainwater.directory").replace(/\/$/, "");

const breadcrumbData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: canonicalSite,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "States",
      item: `${canonicalSite}/states`,
    },
  ],
};

const entries = installers.map((installer) => ({
  state: installer.data.state,
  city: installer.data.city,
  href: withBase(`/installers/${slugify(installer.data.state)}/${slugify(installer.data.city)}`),
}));
---
<BaseLayout
  title="Browse Rainwater Harvesting Installers by State | Rainwater Directory"
  description="Find rainwater harvesting installers and incentives across every U.S. state."
  structuredData={[breadcrumbData]}
>
  <nav aria-label="Breadcrumb" class="text-sm text-slate-600">
    <ol class="flex items-center gap-2">
      <li>
        <a class="text-primary-600 hover:text-primary-700" href={withBase("/")}>
          Home
        </a>
      </li>
      <li aria-hidden="true">/</li>
      <li class="text-slate-500">States</li>
    </ol>
  </nav>

  <SearchBar entries={entries} />

  <section class="mt-6">
    <h1 class="text-3xl font-semibold text-slate-900">Browse states</h1>
    <p class="mt-2 text-base text-slate-600">
      Choose a state to see legality guidance, incentives, and featured cities with verified rainwater harvesting installers.
    </p>
    <div class="mt-8 grid gap-4 md:grid-cols-3">
      {states.map((state) => (
        <a
          href={withBase(`/states/${slugify(state.title)}`)}
          class="group rounded-3xl border border-slate-200 bg-white p-6 shadow-sm transition hover:-translate-y-1 hover:border-primary-200 hover:shadow-lg"
        >
          <h2 class="text-xl font-semibold text-slate-900"><span class="mr-2" aria-hidden="true">{getStateEmoji(state.title)}</span>{state.title}</h2>
          <p class="mt-2 text-sm text-slate-600">{state.summary}</p>
          <span class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-primary-600">
            View cities <span aria-hidden="true">â†’</span>
          </span>
        </a>
      ))}
    </div>
  </section>
</BaseLayout>
