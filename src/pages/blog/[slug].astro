---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { withBase } from "../../utils/paths";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const posts = await getCollection("blog");
const post = posts.find((entry) => entry.slug === slug);

if (!post) {
  throw new Response("Blog post not found", { status: 404 });
}

const { Content } = await post.render();

const canonicalSite = (Astro.site?.toString() ?? "https://rainwater.directory").replace(/\/$/, "");
const postUrl = `${canonicalSite}/blog/${post.slug}`;

const breadcrumbData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: canonicalSite,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Blog",
      item: postUrl,
    },
  ],
};

const blogSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.pubDate,
  author: {
    "@type": "Person",
    name: post.data.author ?? "Rainwater Directory Team",
  },
  url: postUrl,
  publisher: {
    "@type": "Organization",
    name: "Rainwater Directory",
  },
};

const structuredData = [blogSchema, breadcrumbData];
---
<BaseLayout
  title={`${post.data.title} | Rainwater Directory`}
  description={post.data.description}
  structuredData={structuredData}
>
  <nav aria-label="Breadcrumb" class="text-sm text-slate-600">
    <ol class="flex items-center gap-2">
      <li>
        <a class="text-primary-600 hover:text-primary-700" href={withBase("/")}>
          Home
        </a>
      </li>
      <li aria-hidden="true">/</li>
      <li class="text-slate-500">Blog</li>
    </ol>
  </nav>

  <article class="prose prose-slate mt-8 max-w-none prose-headings:font-semibold prose-a:text-primary-600">
    <header>
      <p class="text-sm font-semibold uppercase tracking-wide text-primary-600">Insights</p>
      <h1 class="mt-2 text-3xl font-semibold text-slate-900">{post.data.title}</h1>
      <p class="mt-2 text-sm text-slate-500">Published on {new Date(post.data.pubDate).toLocaleDateString()}</p>
    </header>
    <div class="mt-6">
      <Content />
    </div>
  </article>
</BaseLayout>
